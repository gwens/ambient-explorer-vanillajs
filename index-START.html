<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Navigator</title>
  <link rel="stylesheet" href="style.css">
  <link href="favicons/favicon.ico" rel="icon" type="image/x-icon">
</head>
<body>
  <div class="email-browser">
    <ul class="years"></ul>
    <ul class="months">
      <li class="month header">ALL</li>
      <li class="month">JAN</li>
      <li class="month">FEB</li>
      <li class="month">MAR</li>
      <li class="month">APR</li>
      <li class="month">MAY</li>
      <li class="month">JUN</li>
      <li class="month">JUL</li>
      <li class="month">AUG</li>
      <li class="month">SEP</li>
      <li class="month">OCT</li>
      <li class="month">NOV</li>
      <li class="month">DEC</li>
    </ul>
    <div class="navigation">
      <form class="search-form">
        <input type="text" class="search" placeholder="search me...">
        <ul class="suggestions">
        </ul>
      </form>
    </div>
    <div class="reader">
      <ul class="email-header">
      </ul>
      <div class="email-body">
        
      </div>
    </div>
  </div>
<script type="text/javascript" src="amb-1000.js">// importing as JS for now from local file</script>
<script>

const emails = [];
emails.push(...data);

// Create arrays of years and months for filtering
const allYears = ["1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017"];
const allMonths = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];

// All years and months are visible to start with
let selectedYears = allYears;
let selectedMonths = allMonths;

// Set background picture size to size of viewport and listen for resize
function resize(){
  const body = document.querySelector("body");
  body.style.height = document.documentElement.scrollHeight + "px";
}
resize();
window.addEventListener('resize', resize);
window.addEventListener('scroll', resize);


function populateYears(){
  const years = document.querySelector(".years");
  let yearsHtml = `<li class="year header">ALL</li>`
  for(year = 1994; year <=2017; year++){
    yearsHtml += `<li class="year">${year}</li>`
  }
  years.innerHTML = yearsHtml;
}

populateYears();

function findMatches(wordToMatch, emails) {
  return emails.filter(email => {
    const year = email.id.slice(4,8);
    const month = email.id.slice(9,11);
    // figure out if the email subject, sender or content contains the search string
    // create new regex. pass in the thing to match and the flags you want
    const regex = new RegExp(wordToMatch, 'gi'); // g = global (search the whole string); i = case insensitive
    return (((email.subject && email.subject.match(regex)) // some subjects are blank/null
    || (email.from && email.from.match(regex))
    || (email.content && email.content.match(regex))) 
    // Only display results in the currently selected years and months
    && (selectedYears.indexOf(year) > -1)
    && selectedMonths.indexOf(month) > -1);
  });
}

function displayEmail(e) {
  //console.log(this.id);
  const emailSelected = emails.find(email => email.id === this.id);
  emailHeader.innerHTML = 
  ` <li class="date">Date: ${emailSelected.dateString}</li>
    <li class="sender">From: ${emailSelected.from}</li>
    <li class="subject">Subject: ${emailSelected.subject}</li>
  `
  emailBody.innerHTML = `${emailSelected.content}`;

  // now style the li element as selected
  const miniSelected = document.querySelector(`#${this.id}`);
  const emailMinis = document.querySelectorAll('.email-mini');
  emailMinis.forEach(emailMini => emailMini.classList.remove('selected'));
  miniSelected.classList.add('selected');
}

function displayMatches() {
  const results = findMatches(this.value, emails); // this.value returns the text string! Good to know! not easy to see if you just console.log(this)
  const html = results.map(email => {
    const regex = new RegExp(this.value, 'gi');
    let subjectHtml = email.subject;
    if (subjectHtml && subjectHtml.match(regex)) { subjectHtml = email.subject.replace(regex, `<span class="hl">${this.value}</span>`)};
    let senderHtml = email.from;
    if (senderHtml && senderHtml.match(regex)) { senderHtml = email.from.replace(regex, `<span class="hl">${this.value}</span>`)};
    //if (senderHtml && senderHtml.match(regex)) { senderHtml.replace(regex, `<span class="hl">${this.value}</span>`)};
    return `
      <li class="email-mini" id=${email.id}>
        <div class="sender">${senderHtml}</div>
        <div class="subject">${subjectHtml}</div>
      </li>
    `;
  }).join(''); // map would return an array, so we join it to get one big string

  suggestions.innerHTML = html;
  const emailMinis = document.querySelectorAll('.email-mini');
  // Once the suggestions are displayed, add event listeners so we can click on them and display the relevant email
  emailMinis.forEach(emailMini => emailMini.addEventListener('click', displayEmail));
}

const searchInput = document.querySelector('.search');
const suggestions = document.querySelector('.suggestions');
const emailHeader = document.querySelector('.email-header');
const emailBody = document.querySelector('.email-body');


searchInput.addEventListener('change', displayMatches);
searchInput.addEventListener('keyup', displayMatches);

</script>
  </body>
</html>
